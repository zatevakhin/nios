#!/usr/bin/python
#-*- coding: utf-8 -*-

import os
import logging
import importlib

from .CExploitBase import CExploitBase

from nios.core.auxiliary import exception

IGNORED_MODULES = [
    "__pycache__",
    "__init__"
]

class CExploitsManager:

    def __init__(self, core):
        logging.debug("call %s()", __name__)
        self.mCore = core
        self.mExploits = {}
        self.mLocation = self.mCore.mConfig.get("core.exploits.location")

        self.loadModules()

    def get(self, name: str):
        return self.mExploits.get(name, None)

    def getModulesList(self):
        modules = os.listdir(self.mLocation)
        modules = map(lambda x: os.path.splitext(x)[0], modules)
        modules = filter(lambda x: x not in IGNORED_MODULES, modules)
        modules = map(lambda x: os.path.join(self.mLocation, x), modules)
        modules = map(lambda x: x.replace("/", '.'), modules)
        return list(modules)

    def loadModules(self):
        modules = self.getModulesList()

        for module in modules:
            importlib.import_module(module)

        for module in CExploitBase.__subclasses__():

            obj = module(core=self.mCore)

            try:
                self.mExploits[obj.cve] = obj
                logging.debug("Exploit '%s' is loaded as '%s' in modules manager",
                                module.__name__, obj.cve)

            except AttributeError as e:
                logging.warning(e, module.__name__)
            except Exception:
                logging.exception(exception())

